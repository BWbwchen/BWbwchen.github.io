---
title: "NTHU route"
description: |
  Paper note for NTHU route

author:
  - name: Bo-Wei Chen
    url: https://BWbwchen.github.io/
date: 2022-05-31
output:
  distill::distill_article:
    toc: true
    toc_depth: 4
    self_contained: false
  toc_float: 
    collapsed: false
    smooth_scroll: true
draft: false
creative_commons: CC BY
editor_options: 
  markdown: 
    wrap: 72
categories:
  - EDA
  - routing
  - Paper note
  - CAD
preview: https://cdn.pixabay.com/photo/2016/11/29/13/17/coffee-1869772_960_720.jpg
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## Terminology

### Congestion

-   $\frac{\text{edge usage}}{capacity}$
-   edge usage $d_g$: how many nets route path use this edge.
-   capacity $c_g$: because we project multi-layer into 2D plane, it is the number edge overlapping on the same edge on 2D plane.
-   If a edge within a nets is overflow, then the route is congested.


### Overflow

-   edge usage > capacity


## Goal

Minimize the overflow and then minimize total wire length.



## Initial Stage



### Plane Projection

-   project Multi-layer design on a 2D plane.



### Net Decomposition

-   use FLUTE algorithm to decompose multi-pin net into a set of 2-pin nets.



### Probabilistic Routing

-   If two pin 在同一水平垂直線上，若之中沒有 L shape ，直接連起來
-   在可以使用上下 L的所有 edge 之中, 使用機率 0.5的 demand 去計算期望值
-   主要是在預估繞線的擁擠程度



### Edge shifting

-   主要是稍微兼顧擁擠度的 routing algorithm


### L-shaped Pattern Routing

-   Normal routing algorithm.



## Main Stage

-   **rip up** and **reroute** the *congested* 2-pin nets.
-   Calculate the congestion value of all edge
    -   By [Congestion](#congestion)
-   Construct a congestion sub-intervals.
    -   We collect all overflow edge and form a interval from maximum congestion value and 1. $[\max(\text{congestion}), 1]$.
    -   Then partition the interval above into $m$ intervals.
    -   Partition the value from big to small: $I_1, I_2, \dots, I_m$.
-   For each interval $I_i$ from $I_1, I_2, \dots, I_m$ with **specific order**
    -   order here
        -   *NTHU route 1.0*
            -   from the biggest congetion value of interval to the smallest
        -   *NTHU route 2.0*
            -   from the smallest congetion value of interval to the biggest
            -   The reroute can route with more routing resource.
    -   Sequentially picks edge $g$ with congestion in $I_i$
    -   Set $g$ as the center, and expands a region $r_g$ until the average congestion of this region is smaller than the lower bound of $I_i$.
    -   Mark the nets in the region $r_g$ as reroute-needed.
    -   Reroute the marked nets by Monotonic Routing with **specific order**.
        -   If reroute and find a overflow-free path, use it.
        -   else, use adaptive multi-source molti-sink maze routing.
        -   *NTHU route 1.0*
            -   from the biggest net bounding box size to the smallest
        -   *NTHU route 2.0*
            -   from the smallest net bounding box size to the biggest
            -   The reroute can route with more routing resource.
-   **Stop condition**
    -   If the total overflow is lower than a predefined threshold.
    -   or the iterations count is higher than a predefined number.



### Cost in this stage for re-routing

-   We will define a edge cost for all edge.
-   The cost of a net is the sum of the cost of edge it use.


#### Cost(NTHU route 1.0)

$$
    cost_g = b_g + h_g \times p_g + vc_g
$$

-   $b_g$: base cost for use edge $g$, it means the wire length in this stage.
    $$
        b_g = 1
      $$
-   $h_g \times p_g$: congestion cost
    -   $h_g$: historical term.
        $$
                h_g^{i+1} = \{\begin{array}{lr}
                h_g^i + 1, & \text{if $g$ has overflow}\\
                h_g^i, & \text{otherwise}
                \end{array}
            $$
    -   $p_g$: congestion penalty term.
        $$
            p_g = (\frac{d_g + 1}{c_g})^{k_1}
            $$
-   $vc_g$: vias cost.
    $$
          vc_g = \{\begin{array}{lr}
          1, & \text{if pass $g$ will make a bend}\\
          0, & \text{otherwise}
          \end{array}
      $$



#### Cost(NTHU route 2.0)

$$
    cost_g = b_g + h_g \times p_g + vc_g
$$

-   $b_g$: base cost for use edge $g$, it means the wire length in this stage.
    $$
        b_g = 1 - e^{-\beta e^{-\gamma i}}
      $$
    The graph of this cost function:
    
    ![https://imgur.com/wSOm4LD.png](https://imgur.com/wSOm4LD.png)
    
    The strategy it use is to focus on wire length at the begin time, and change the focus to the congestion at the middle time and the end time.
-   $h_g \times p_g$: congestion cost
    -   $h_g$: historical term.
        $$
                h_g^{i+1} = \{\begin{array}{lr}
                h_g^i + 1, & \text{if $g$ has overflow}\\
                h_g^i, & \text{otherwise}
                \end{array}
            $$
    -   $p_g$: congestion penalty term.
        $$
                p_g = (\frac{d_g + 1}{c_g} \times f(h_g, i))^{k_1}
            $$
        where $f(h_g, i)$ is defined:
        $$
                f(h_g, i) = \frac{i(k_2 + adj(i))}{i(k_2 + adj(i)) - (h_g - 1)}
            $$
        $$
            adj(i) = k_3 \times (1 - e^{-\beta e^{-\gamma i}})
            $$
-   $vc_g$: vias cost.
    $$
          vc_g = \{\begin{array}{lr}
          v_g \times c_g \times b_g, & \text{if pass $g$ will make a bend}\\
          0, & \text{otherwise}
          \end{array}
      $$
    -   $v_g$ is the expected number of vias
    
    -   $c_g$ is the cost of vias
    
    -   $b_g$ is the base cost



## Refinement Stage

-   Mainly focus on finding an overflow-free path for every congestion two-pin nets.
-   Directly reroute the nets with overflow edge.



### Cost in this stage for re-routing

$$
      cost_g = \{\begin{array}{lr}
      1, & \text{if $g$ has overflow}\\
      0, & \text{otherwise}
      \end{array}
  $$



## Layer Assignment Stage

-   Map projected 2D plane back to multiple layers design.


