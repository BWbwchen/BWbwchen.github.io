---
title: "Tinyurl"
description: |
  Build a Full-Stack Tinyurl service in golang using Gin, Redis, MongoDB and Zookeeper

author:
  - name: Bo-Wei Chen
    url: https://BWbwchen.github.io/
date: 2021-08-16
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    self_contained: false
  toc_float: 
    collapsed: false
    smooth_scroll: true
draft: false
creative_commons: CC BY
editor_options: 
  markdown: 
    wrap: 72
categories:
  - golang
  - docker
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
# Tinyurl

Recently, I learned the system design and tried my best to implement a full-stack tinyurl service. Throughout this journey, I also learned how to build a CI/CD pipeline (you can check [this posts](/posts/shorturlcicd)) and also learned how to use kubernetes.

## Architecture
![](/img/tinyurl-overview.jpg)

![](/img/system_architecture.jpg)

I built this service on my own server, used nginx to serve static vue frontend. 

I design this system aim to have 100 URLs requents per second, So the shorten name will have 7 characters and generated by use MD5.

First, each api server got a range of number from Zookeeper, and then use that number to generate the MD5 value, this method can guarantee that the hash code won't collision. 

Second, take the first 7 characters as short name, you need to check whether this short name is existing in the database. If existed in database, just shift a character. 

Third, store into database and redis cache. 

For get long URL, find in redis cache first. if not found, find in the database.

## Deploy
I deployed my service on rancher kubernetes 2.4.16
![](/img/tinyurl-deploy.png)

## CI/CD (both frontend and backend)
I managed my code in self-hosted gitlab with gitlab-ci.

### backend
![](/img/tinyurl-cicd-backend.png)

### frontend
![](/img/tinyurl-cicd-frontend.png)

## Problem
1. Although I had checked the short name collision, I still got a lot of collision. Then I found it is the api server's problem. A client send request to api server, server will create a thread to handle that request, and use the counter number to compute the hash value. What if 2 thread use counter value simultaneously ? They will use same value to compute short name, and that short name doesn't in database and they will be store in database and redis cache! 

	So I make a mutex lock on counter variable to fix this bug.

2. Vue environment variable disappear when deploy on kubernetes. When I build the docker image of Vue frontend, I can't build it with backend way. In my api server, I can modify environment variable when I deploy the service on Kubernetes. I can input the environment variable in deployment yaml file. But when I do the same thing to Vue frontend docker image. I can not pass the environment variable via deployment yaml. At the end, I found that I should input the environment variable when I build the docker image.

## Future
I want to try to import microservice to this project, or future project.